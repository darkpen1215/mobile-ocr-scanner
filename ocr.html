<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4ä½æ•¸ç²¾æº–è¾¨è­˜ V3 (ç©©å®šç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #1a1a1a;
            color: white;
            margin: 0;
            padding: 20px;
        }

        .video-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            aspect-ratio: 1/1; 
            margin-bottom: 20px;
            overflow: hidden;
            border-radius: 20px;
            background: #000;
            border: 2px solid #444;
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* æƒææ¡†å€åŸŸ (é«˜åº¦ 100px) */
        .scan-region {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60%;       
            height: 100px;     
            border: 3px solid #00ff00;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.6);
            z-index: 10;
            border-radius: 8px;
        }

        #scanBtn {
            padding: 18px 50px;
            font-size: 20px;
            background-color: #00ff00;
            color: #000;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 5px 20px rgba(0, 255, 0, 0.4);
            transition: 0.2s;
        }

        #scanBtn:active { transform: scale(0.95); }
        #scanBtn:disabled { background-color: #444; color: #888; box-shadow: none; cursor: not-allowed; }

        #result-box {
            margin-top: 30px;
            text-align: center;
        }
        #result-text {
            font-size: 56px;
            font-weight: bold;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            min-height: 70px;
            letter-spacing: 5px;
        }
        #status { font-size: 14px; color: #888; margin-top: 10px; }

        canvas { display: none; }
    </style>
</head>
<body>

    <h2>ğŸ¯ 4ä½æ•¸ç²¾æº–è¾¨è­˜ V3 (ç©©å®šç‰ˆ)</h2>
    
    <div class="video-container">
        <video id="video" playsinline autoplay></video>
        <div class="scan-region"></div>
    </div>

    <button id="scanBtn" disabled>å¼•æ“è¼‰å…¥ä¸­...</button>
    
    <div id="result-box">
        <div id="result-text">----</div>
        <div id="status">è«‹å°æº–æ•¸å­—å¾ŒæŒ‰ä¸‹æŒ‰éˆ•</div>
    </div>

    <canvas id="canvas"></canvas>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const scanBtn = document.getElementById('scanBtn');
        const resultText = document.getElementById('result-text');
        const statusDiv = document.getElementById('status');
        
        let worker = null;

        // åˆå§‹åŒ–ç›¸æ©Ÿ
        async function initCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment', 
                        width: 1920,   // è«‹æ±‚æ›´é«˜çš„è§£æåº¦ 
                        height: 1080 
                    } 
                });
                video.srcObject = stream;
            } catch (err) {
                statusDiv.innerText = "ç„¡æ³•å­˜å–ç›¸æ©Ÿï¼Œè«‹æª¢æŸ¥ HTTPS è¨­å®š";
                console.error("Camera access error:", err);
            }
        }

        // åˆå§‹åŒ– Tesseract
        async function initTesseract() {
            statusDiv.innerText = "æ­£åœ¨è¼‰å…¥è¾¨è­˜å¼•æ“...";
            worker = await Tesseract.createWorker('eng');
            await worker.setParameters({
                tessedit_char_whitelist: '0123456789',
                tessedit_pageseg_mode: '8', // ç¶­æŒ PSM=8 (å–®å€‹å–®è©)
            });
            scanBtn.disabled = false;
            scanBtn.innerText = "ç«‹å³æƒæ";
            statusDiv.innerText = "è«‹å°æº–æ•¸å­—å¾ŒæŒ‰ä¸‹æŒ‰éˆ•";
        }

        // å½±åƒå¢å¼·è™•ç†
        function processCapture(ctx, width, height) {
            const imageData = ctx.getImageData(0, 0, width, height);
            const data = imageData.data;
            for (let i = 0; i < data.length; i += 4) {
                const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
                // å¼·åŠ›äºŒå€¼åŒ–ï¼šé–¾å€¼ 150
                const val = avg > 150 ? 255 : 0; 
                data[i] = data[i + 1] = data[i + 2] = val;
            }
            ctx.putImageData(imageData, 0, 0);
        }

        // åŸ·è¡Œå–®æ¬¡è¾¨è­˜
        async function performScan() {
            // UI ç‹€æ…‹æ›´æ–°
            scanBtn.disabled = true;
            scanBtn.innerText = "è¾¨è­˜ä¸­...";
            resultText.style.color = "#555";
            statusDiv.innerText = "æ­£åœ¨åˆ†æå½±åƒ (ç­‰å¾…çµæœ)...";

            // ç¢ºä¿ video metadata å·²è¼‰å…¥
            if (video.videoWidth === 0) {
                 statusDiv.innerText = "ç›¸æ©Ÿå½±åƒå°šæœªæº–å‚™å¥½ï¼Œè«‹ç¨å€™ã€‚";
                 scanBtn.disabled = false;
                 scanBtn.innerText = "ç«‹å³æƒæ";
                 return;
            }
            
            const w = video.videoWidth;
            const h = video.videoHeight;
            const ctx = canvas.getContext('2d');

            const videoContainer = document.querySelector('.video-container');
            const scanRegion = document.querySelector('.scan-region');

            const cssCropWidthRatio = parseFloat(scanRegion.style.width) / 100;
            const cssCropHeight = parseFloat(scanRegion.style.height);

            const cropW = w * cssCropWidthRatio;
            const cropH = (h / videoContainer.offsetHeight) * cssCropHeight;

            const startX = (w - cropW) / 2;
            const startY = (h - cropH) / 2;

            // ä¿®æ­£: é™ä½æ”¾å¤§å€æ•¸è‡³ 3 å€ (æˆ– 4 å€)ï¼Œæ¸›å°‘ Tesseract è¨ˆç®—é‡
            const scaleFactor = 3; 
            canvas.width = cropW * scaleFactor;
            canvas.height = cropH * scaleFactor;

            ctx.drawImage(video, startX, startY, cropW, cropH, 0, 0, canvas.width, canvas.height);
            processCapture(ctx, canvas.width, canvas.height);

            // ä½¿ç”¨ Promise.race å¯¦ç¾è¶…æ™‚æ©Ÿåˆ¶ï¼Œé¿å…é•·æ™‚é–“å¡ä½
            const recognizePromise = worker.recognize(canvas);
            const timeoutPromise = new Promise((_, reject) => 
                setTimeout(() => reject(new Error("OCR è¾¨è­˜è¶…æ™‚ (Timeout)")), 5000) // è¨­ç½® 5 ç§’è¶…æ™‚
            );

            try {
                const result = await Promise.race([recognizePromise, timeoutPromise]);
                const { data: { text, confidence } } = result;
                
                const digits = text.replace(/\D/g, '').trim(); 

                if (digits.length === 4) {
                    resultText.innerText = digits;
                    resultText.style.color = "#00ff00";
                    statusDiv.innerText = `è¾¨è­˜æˆåŠŸ (ä¿¡å¿ƒåº¦: ${Math.round(confidence)}%)`;
                } else if (digits.length > 0) {
                    resultText.innerText = digits;
                    resultText.style.color = "#ffdd00";
                    statusDiv.innerText = `åµæ¸¬åˆ° ${digits.length} ä½æ•¸ (${digits})ï¼Œè«‹å°æº– 4 ä½æ•¸å­—é‡è©¦`;
                } else {
                    resultText.innerText = "----";
                    statusDiv.innerText = "æœªèƒ½è¾¨è­˜æ•¸å­—ï¼Œè«‹é è¿‘ä¸€é»æˆ–æ”¹å–„å…‰ç·š";
                    resultText.style.color = "#ff5555";
                }
            } catch (err) {
                resultText.innerText = "----";
                resultText.style.color = "#ff5555";
                if (err.message.includes("Timeout")) {
                    statusDiv.innerText = "è¾¨è­˜è¶…æ™‚ï¼Œè«‹é‡è©¦æˆ–é è¿‘æ•¸å­—ã€‚";
                } else {
                    statusDiv.innerText = "è¾¨è­˜å‡ºéŒ¯ï¼Œè«‹é‡è©¦";
                }
                console.error("OCR error:", err);
            }

            // æ¢å¾©æŒ‰éˆ•
            scanBtn.disabled = false;
            scanBtn.innerText = "ç«‹å³æƒæ";
        }

        scanBtn.addEventListener('click', performScan);

        // å•Ÿå‹•æµç¨‹
        (async () => {
            await initCamera();
            video.addEventListener('loadedmetadata', async () => {
                await new Promise(r => setTimeout(r, 1000)); 
                await initTesseract();
            }, { once: true });
        })();
    </script>
</body>
</html>
