<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4ä½æ•¸ç²¾æº–æƒæå™¨</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #1a1a1a;
            color: white;
            margin: 0;
            padding: 20px;
        }

        .video-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            aspect-ratio: 1/1; /* æ”¹ç‚ºæ­£æ–¹å½¢æ›´ç›´è¦º */
            margin-bottom: 20px;
            overflow: hidden;
            border-radius: 20px;
            background: #000;
            border: 2px solid #444;
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* æƒææ¡†å€åŸŸ */
        .scan-region {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60%;       
            height: 50px;     
            border: 3px solid #00ff00;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.6);
            z-index: 10;
            border-radius: 8px;
        }

        #scanBtn {
            padding: 18px 50px;
            font-size: 20px;
            background-color: #00ff00;
            color: #000;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 5px 20px rgba(0, 255, 0, 0.4);
            transition: 0.2s;
        }

        #scanBtn:active { transform: scale(0.95); }
        #scanBtn:disabled { background-color: #444; color: #888; box-shadow: none; cursor: not-allowed; }

        #result-box {
            margin-top: 30px;
            text-align: center;
        }
        #result-text {
            font-size: 56px;
            font-weight: bold;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            min-height: 70px;
            letter-spacing: 5px;
        }
        #status { font-size: 14px; color: #888; margin-top: 10px; }

        canvas { display: none; }
    </style>
</head>
<body>

    <h2>ğŸ¯ 4ä½æ•¸ç²¾æº–è¾¨è­˜ V3</h2>
    
    <div class="video-container">
        <video id="video" playsinline autoplay></video>
        <div class="scan-region"></div>
    </div>

    <button id="scanBtn" disabled>å¼•æ“è¼‰å…¥ä¸­...</button>
    
    <div id="result-box">
        <div id="result-text">----</div>
        <div id="status">è«‹å°æº–æ•¸å­—å¾ŒæŒ‰ä¸‹æŒ‰éˆ•</div>
    </div>

    <canvas id="canvas"></canvas>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const scanBtn = document.getElementById('scanBtn');
        const resultText = document.getElementById('result-text');
        const statusDiv = document.getElementById('status');
        
        let worker = null;

        // åˆå§‹åŒ–ç›¸æ©Ÿ
        async function initCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment', width: 1280, height: 720 } 
                });
                video.srcObject = stream;
            } catch (err) {
                statusDiv.innerText = "ç„¡æ³•å­˜å–ç›¸æ©Ÿï¼Œè«‹æª¢æŸ¥ HTTPS è¨­å®š";
            }
        }

        // åˆå§‹åŒ– Tesseract
        async function initTesseract() {
            worker = await Tesseract.createWorker('eng');
            await worker.setParameters({
                tessedit_char_whitelist: '0123456789',
                tessedit_pageseg_mode: '8', // è¦–ç‚ºå–®è¡Œæ–‡å­—
            });
            scanBtn.disabled = false;
            scanBtn.innerText = "ç«‹å³æƒæ";
        }

        // å½±åƒå¢å¼·è™•ç†
        function processCapture(ctx, width, height) {
            const imageData = ctx.getImageData(0, 0, width, height);
            const data = imageData.data;
            for (let i = 0; i < data.length; i += 4) {
                const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
                // å¼·åŠ›äºŒå€¼åŒ–ï¼šéæ¿¾ç°è‰²é›œè¨Šï¼Œè®“æ•¸å­—é»‘ç™½åˆ†æ˜
                const val = avg > 150 ? 255 : 0; 
                data[i] = data[i + 1] = data[i + 2] = val;
            }
            ctx.putImageData(imageData, 0, 0);
        }

        // åŸ·è¡Œå–®æ¬¡è¾¨è­˜
        async function performScan() {
            // UI ç‹€æ…‹æ›´æ–°
            scanBtn.disabled = true;
            scanBtn.innerText = "è¾¨è­˜ä¸­...";
            resultText.style.color = "#555";
            statusDiv.innerText = "æ­£åœ¨åˆ†æå½±åƒ...";

            const w = video.videoWidth;
            const h = video.videoHeight;
            const ctx = canvas.getContext('2d');

            // è¨ˆç®—ç²¾ç¢ºè£åˆ‡ä½ç½®
            const cropW = w * 0.6;
            const cropH = (h / video.offsetHeight) * 70;
            const startX = (w - cropW) / 2;
            const startY = (h - cropH) / 2;

            // æ”¾å¤§ 3 å€ï¼ˆå–®æ¬¡æƒæå¯ä»¥æ‰¿å—æ›´é«˜çš„é‹ç®—é‡ä»¥æ›å–ç²¾æº–åº¦ï¼‰
            canvas.width = cropW * 5;
            canvas.height = cropH * 5;

            ctx.drawImage(video, startX, startY, cropW, cropH, 0, 0, canvas.width, canvas.height);
            processCapture(ctx, canvas.width, canvas.height);

            try {
                const { data: { text, confidence } } = await worker.recognize(canvas);
                const digits = text.replace(/\D/g, '').trim();

                // æª¢æŸ¥æ˜¯å¦ç‚º 4 ä½æ•¸
                if (digits.length === 4) {
                    resultText.innerText = digits;
                    resultText.style.color = "#00ff00";
                    statusDiv.innerText = `è¾¨è­˜æˆåŠŸ (ä¿¡å¿ƒåº¦: ${Math.round(confidence)}%)`;
                } else if (digits.length > 0) {
                    resultText.innerText = digits;
                    statusDiv.innerText = `åµæ¸¬åˆ° ${digits.length} ä½æ•¸ï¼Œè«‹å°æº– 4 ä½æ•¸å­—é‡è©¦`;
                } else {
                    statusDiv.innerText = "æœªèƒ½è¾¨è­˜æ•¸å­—ï¼Œè«‹é è¿‘ä¸€é»æˆ–æ”¹å–„å…‰ç·š";
                }
            } catch (err) {
                statusDiv.innerText = "è¾¨è­˜å‡ºéŒ¯ï¼Œè«‹é‡è©¦";
                console.error(err);
            }

            // æ¢å¾©æŒ‰éˆ•
            scanBtn.disabled = false;
            scanBtn.innerText = "ç«‹å³æƒæ";
        }

        scanBtn.addEventListener('click', performScan);

        (async () => {
            await initCamera();
            await initTesseract();
        })();
    </script>
</body>
</html>



